<html> 
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="js/leaflet.css"/>
    <script src="js/leaflet.js"></script>
	<script src="js/leaflet.rotatedMarker.js"></script>
		<style>
		html, body {
			height: 100%;
			margin: 0;
		}
		#map {
			width: 90%;
			height: 800px;
		}
	</style>
	
	</head>
	<body>
	
	<div id="map"></div>

<script>


	var map = L.map('map', {minZoom: 3, maxZoom: 11, zoomSnap: 0, zoomDelta: 0.5, center: [39.73, -104.99],})
	map.setView([0, 0], 0);

	map.fitBounds([
		[90, -180],
		[-90, 180]
	]);

	// Eventhandler on map
	map.on("contextmenu", function (event) {
		draw_area(event);
		update_flights();
		
		console.log("LAT orig: " + event.latlng.lat + " fixed: " + norm(event.latlng.lat, 85));
		console.log("LNG orig: " + event.latlng.lng + " fixed: " + norm(event.latlng.lng, 180));
	});

	// Show grounded flights checkbox
	var grounded_cb = L.control({position: 'topright'});
	
	grounded_cb.onAdd = function(map) {
		var div = L.DomUtil.create('div', 'grounded_cb');
		div.innerHTML = '<form><input id="grounded_cb" type="checkbox"/>Show grounded planes</form>';
		return div;
	}

	var radius_slider = L.control({position: 'topright'});
	
	radius_slider.onAdd = function(map) {
		var div = L.DomUtil.create('div', 'grounded_cb');
		div.innerHTML = '<form><input type="range" min="10000" max="500000" value="400000" class="slider" id="radius_slider">Radius</form>';
		return div;
	}

	grounded_cb.addTo(map);
	document.getElementById ("grounded_cb").addEventListener ("click", show_grounded, false);
	
	radius_slider.addTo(map);
	document.getElementById ("radius_slider").addEventListener ("change", set_radius, false);	
	
	L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {noWrap: true}).addTo(map);

	
	// Global Variables
	var trackingArea = null; // Tracking area marked by circle
	var flight_layergroup = null;
	var ground_layergroup = null;
	var flight_data;
	
	var show_grounded = false;
	
	// Icons
	var plane_flying = L.icon({iconUrl: 'img/plane_fly.PNG', iconSize: [43, 45], iconAnchor: [21, 22]});
	var plane_grounded = L.icon({iconUrl: 'img/plane_grounded.PNG', iconSize: [43, 45], iconAnchor: [21, 22]});
	
	// Request
	var myHeaders = new Headers();
	myHeaders.append("Authorization", "Basic Y2thOlN0b25lZDEyMzQs");
	myHeaders.append("Cookie", "XSRF-TOKEN=6541dea4-0434-4d10-b6cd-12c7af32a8df");

	var requestOptions = { method: 'GET', headers: myHeaders, redirect: 'follow'};
	
	// Add reference marker for Ostfalia
	L.marker([52.178928, 10.559365]).addTo(map).bindTooltip("<b>Ostfalia</b>", {permanent: true, direction: 'right', opacity: 0.6});

	function show_grounded() {
		if (!show_grounded) {
			show_grounded = true;
		} else {
			show_grounded = false;
		}
	}
	
	function set_radius() {
		if (trackingArea != null) {
			trackingArea.setRadius(document.getElementById("radius_slider").value);
			console.log(document.getElementById("radius_slider").value);
		}
	}
		

	function norm(lat_or_lng, max) {
		if (lat_or_lng > max || lat_or_lng < -max) {
			lat_or_lng = (lat_or_lng + max) % 360 - max;
		}
		return lat_or_lng;
	}
	
	function clear_flights() {
		if (flight_layergroup != null) {
			flight_layergroup.removeFrom(map);	
		}
		if (ground_layergroup != null) {
			ground_layergroup.removeFrom(map);	
		}
	}
	
	function update_flights() {
		setInterval( () => { draw_flights()}, 5000);
	}
	
	function draw_flights() {
		let flight_data = get_data();
		
		Promise.all([flight_data]).then(flight_data => {
			var tracked_flying = [];
			var tracked_grounded = [];
		
			var marker, callsign, lat, lon;		
			for (i = 0; i < flight_data[0].states.length; i++) {
				callsign = flight_data[0].states[i][1];
				latitude = flight_data[0].states[i][6];
				longitude = flight_data[0].states[i][5];
				true_track = flight_data[0].states[i][10];
				on_ground = flight_data[0].states[i][8];
				// Create marker only for flying aircraft
				if (on_ground && show_grounded) {
					tracked_grounded.push(L.marker([latitude, longitude], {icon: plane_grounded,rotationAngle: true_track}).bindTooltip(callsign,{permanent: true, direction: 'right', opacity: 0.8}));	
				} else {
					tracked_flying.push(L.marker([latitude, longitude], {icon: plane_flying, rotationAngle: true_track}).bindTooltip(callsign,{permanent: true, direction: 'right', opacity: 0.8}));
				}
			}		
			
			clear_flights(); // Delete old layergroup
			flight_layergroup = L.layerGroup(tracked_flying).addTo(map);// Create new layergroup
			ground_layergroup = L.layerGroup(tracked_grounded).addTo(map);// Create new layergroup
		});
	}

	function draw_area(event) {
		if (flight_layergroup != null) { clear_flights() }
		
		var lat, lng;
		lat = norm(event.latlng.lat, 90);
		lng = norm(event.latlng.lng, 180);
		

		
		if (trackingArea == null) {
			trackingArea = L.circle([lat, lng], {color: 'red', stroke: false, fillColor: '#f03', fillOpacity: 0.05, radius: 400000}).addTo(map);
		} else {
			trackingArea.setLatLng([lat, lng]);
		}
	}
	
	function get_data() {
		var lamin = trackingArea.getBounds()._southWest.lat;
		var lamax = trackingArea.getBounds()._northEast.lat;
		var lomin = trackingArea.getBounds()._southWest.lng;
		var lomax = trackingArea.getBounds()._northEast.lng;
		

		console.log( 'https://opensky-network.org/api/states/all?lamin=' + lamin + '&lomin=' + lomin +'&lamax=' + lamax + '&lomax=' + lomax);	
		
		var rest_all_states = 'https://opensky-network.org/api/states/all?lamin=' + lamin + '&lomin=' + lomin +'&lamax=' + lamax + '&lomax=' + lomax;
		
		return fetch(rest_all_states, requestOptions).then(async response => {
			var flight_data = await response.json();
			return flight_data;
		})
	}
</script>
	</body>
	
</html>